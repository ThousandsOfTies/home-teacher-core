# 画像取込・デジタルバインダー機能 (PDF変換) 設計仕様詳細

**最終更新**: 2026-02-15 23:22
**ステータス**: 計画中 (Draft)

## 1. 概要
学習ドリルのデジタル化に加え、**塾のプリント等の管理**を効率化するため、PDF以外の画像ファイル (JPG, PNG, HEIC) の取り込みを可能にする。

### 目的
- 塾や学校のプリントをスマートフォンで撮影し、そのままアプリに取り込めるようにする。
- 複数のプリント画像を**1つのPDFブック**としてまとめて管理する「デジタルバインダー」機能を提供。
- **画質補正 (コントラスト、歪み)** により、読みやすく美しい状態で保存する。

## 2. 要件定義

### 2.1 入力フォーマットの拡大
- **PDF**: 既存の通りサポート。
- **画像**: JPG, PNG に加え、iPhoneで標準的な **HEIC** 形式をサポート。
- **操作**: ファイル選択、またはフォルダごとのドラッグ＆ドロップに対応。

### 2.2 自動PDF変換と結合 (デジタルバインダー)
- 複数の画像を選択した場合、それらを自動的にページ順に結合し、**1つのPDFファイル**として保存する。
- ユーザーはページの順序を並べ替えることができる (ドラッグ＆ドロップ)。
- **出力**: 最終的に生成されるのは標準的なPDFファイル。これにより、既存の学習機能・書き込み機能がそのまま利用可能。

### 2.3 画質補正と編集
1.  **コントラスト調整 (白黒強調)**:
    - プリントの文字をはっきりさせ、裏写りや影を軽減する。
    - 閾値（Threshold）調整スライダーを提供。
2.  **歪み補正 (台形補正)**:
    - 斜めから撮影した画像の歪みを補正し、真正面から見たように修正する。
    - **手動**: 四隅のハンドルを操作して補正。
    - **自動**: 将来的にはAI/OpenCV等による自動検出も検討。
3.  **回転・トリミング**:
    - 向きの修正や余白のカット。

## 3. 技術的アプローチとライブラリ選定

### 3.1 PDF変換・操作
- **`jspdf`**: ブラウザ上で画像をPDFに変換・生成するために使用。
- **`pdf-lib`** (既存): 既存PDFの結合やメタデータ操作に使用。

### 3.2 画像処理
- **`heic2any`**: HEIC形式をブラウザで扱えるJPEG/PNGに変換。
- **Canvas API**: 基本的な回転、トリミング、リサイズ処理。
- **CSS Filters / WebGL**: コントラスト調整のプレビュー表示 (高速化)。
- **OpenCV.js** (検討中): 高度な歪み補正や自動検出が必要な場合に採用。まずは Canvas での簡易実装から開始を推奨。

### 3.3 データフロー
1.  **アップロード**: ユーザーが画像を選択 (Client側)。
2.  **前処理**: HEIC等の変換、サムネイル生成。
3.  **編集UI**: ユーザーが順序並べ替え、補正を実施。
4.  **PDF生成**: `jspdf` で画像をページとして追加し、バイナリデータを生成。
5.  **保存**: 生成されたPDFデータをIndexedDBに保存 (既存フローと同じ)。

## 4. UI/UX 設計案

### 4.1 新規取込モーダル (拡張)
- **ドロップエリア**: "PDFまたは画像をここにドロップ"
- **プレビューエリア**: 取り込んだ画像がグリッドまたはリストで表示される。
- **操作ツール**:
    - [並べ替え]: ドラッグ＆ドロップでページ順を変更。
    - [編集]: 各画像に対して「補正」「回転」「削除」ボタン。
    - [結合して保存]: "output.pdf" として保存するボタン。

### 4.2 画像編集モード (モーダル内または別画面)
- **プレビュー**: 補正結果をリアルタイム表示。
- **スライダー**: コントラスト、明るさ。
- **ハンドル**: 台形補正用の四隅ポイント。

## 5. 実装フェーズ (ロードマップ)

### Phase 1: 基本的な画像取り込みとPDF変換
- JPG/PNG/HEIC の入力対応。
- 単一/複数画像をそのままPDFに変換して保存。
- `jspdf`, `heic2any` の導入。

### Phase 2: 順序並べ替えと結合 (デジタルバインダー)
- 複数画像のプレビューと並べ替えUI。
- 結合処理の実装。

### Phase 3: 画質補正 (コントラスト・回転)
- 画像ごとの簡易編集機能。
- 読みやすさ向上のためのフィルター処理。

### Phase 4: 高度な補正 (歪み補正)
- OpenCV.js 等を用いた台形補正。
- 自動検出機能。

## 6. 懸念事項・注意点
- **パフォーマンス**: 高解像度画像を多数扱う場合、ブラウザのメモリ消費に注意。適宜リサイズや圧縮を行う必要がある。
- **HEIC変換**: ブラウザでの変換は多少時間がかかる場合があるため、ローディング表示が必要。
